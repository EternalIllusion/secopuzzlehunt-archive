{
  "type": "problem",
  "title": "声・韵・调",
  "extendData": "",
  "contentType": 1,
  "content": "\n<p></p>\n<style>\n    .syd-container { max-width: 800px; margin: auto; padding: 20px; background-color: #f4f4f4; border-radius: 12px; }\n    .syd-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-size: 1.2rem; flex-wrap: wrap; gap: 10px; }\n    .syd-level-nav { display: flex; align-items: center; gap: 15px; }\n    .syd-nav-btn { font-size: 1.5rem; font-weight: bold; cursor: pointer; padding: 0 10px; border-radius: 5px; user-select: none; }\n    .syd-nav-btn:hover { background-color: #ddd; }\n    .syd-nav-btn.disabled { color: #aaa; cursor: not-allowed; background-color: transparent; }\n    \n    .syd-image-wrapper { width: 100%; max-width: 600px; margin: 0 auto 20px; }\n    .syd-image { width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }\n    .syd-controls { display: flex; gap: 10px; margin-bottom: 10px; }\n    #syd-submission-input { flex-grow: 1; padding: 10px; font-size: 1rem; }\n    .syd-feedback { min-height: 24px; font-weight: bold; margin-top: 5px; }\n    .syd-image-caption { margin-bottom: 15px; font-style: italic; color: #555; background-color: #fff; padding: 15px; border-radius: 8px; }\n</style>\n\n<div class=\"syd-container\">\n    <div class=\"syd-header\">\n        <div class=\"syd-level-nav\">\n            <div id=\"syd-prev-btn\" class=\"syd-nav-btn\">&lt;</div>\n            <span id=\"syd-level-text\">当前小关: <b id=\"syd-level-display\"></b></span>\n            <div id=\"syd-next-btn\" class=\"syd-nav-btn\">&gt;</div>\n        </div>\n        <span id=\"syd-attempts-container\" style=\"display: none;\">\n            剩余提交次数: <b id=\"syd-attempts-display\"></b>\n        </span>\n    </div>\n\n    <div class=\"syd-image-caption\" id=\"syd-level-description\">\n        正在加载...\n    </div>\n\n    <div class=\"syd-image-wrapper\">\n        <img id=\"syd-image\" src=\"\" alt=\"Puzzle Image\" class=\"syd-image\">\n    </div>\n\n    <div id=\"syd-interaction-area\" style=\"display: none;\">\n        <div id=\"syd-submission-area\" class=\"syd-controls\" style=\"display: none;\">\n            <input type=\"text\" id=\"syd-submission-input\" placeholder=\"输入答案\">\n            <button id=\"syd-submit-btn\" class=\"btn\">{% translate \"提交\" %}</button>\n        </div>\n        <div id=\"syd-answer-area\" style=\"display: none; padding: 15px; background: #e8f5e9; border-radius: 8px; font-weight: bold; color: #2e7d32;\">\n            正确答案：<span id=\"syd-answer-display\"></span>\n        </div>\n        <div class=\"syd-feedback\" id=\"syd-feedback-display\"></div>\n        <div class=\"syd-actions\" id=\"syd-actions-area\" style=\"display: flex; gap: 10px; margin-top: 15px;\">\n            <button id=\"syd-exchange-btn\" class=\"btn btn-secondary\">\n                使用提示点换次数 (消耗 {{ SYD_HINT_COST|default:1 }})\n                (可用: <span id=\"hint-balance-display\">{{ team.num_hints_remaining|default:0|truncate_two_decimals }}</span>)\n            </button>\n        </div>\n    </div>\n</div>\n\n<script>\ndocument.addEventListener('DOMContentLoaded', () => {\n    // --- DOM 元素获取 ---\n    const levelDisplay = document.getElementById('syd-level-display');\n    const levelText = document.getElementById('syd-level-text');\n    const imageEl = document.getElementById('syd-image');\n    const descriptionEl = document.getElementById('syd-level-description');\n    const prevBtn = document.getElementById('syd-prev-btn');\n    const nextBtn = document.getElementById('syd-next-btn');\n\n    const interactionArea = document.getElementById('syd-interaction-area');\n    const submissionArea = document.getElementById('syd-submission-area');\n    const answerArea = document.getElementById('syd-answer-area');\n    const answerDisplay = document.getElementById('syd-answer-display');\n    const actionsArea = document.getElementById('syd-actions-area');\n    const attemptsContainer = document.getElementById('syd-attempts-container');\n    const attemptsDisplay = document.getElementById('syd-attempts-display');\n    const inputEl = document.getElementById('syd-submission-input');\n    const submitBtn = document.getElementById('syd-submit-btn');\n    const feedbackDisplay = document.getElementById('syd-feedback-display');\n    const exchangeBtn = document.getElementById('syd-exchange-btn');\n    const hintBalanceDisplay = document.getElementById('hint-balance-display');\n\n    // --- 数据初始化 ---\n    const apiUrl = \"{% url 'syd_api' %}\";\n    const csrfToken = \"{{ csrf_token }}\";\n    const TOTAL_LEVELS = {{ SYD_DATA|length|default:4 }};\n    const SUBMITTABLE_LEVELS = 3;\n\n    let teamCurrentLevel = parseInt(\"{{ team.syd_state.current_level|default:1 }}\");\n    let viewingLevel = teamCurrentLevel > SUBMITTABLE_LEVELS ? SUBMITTABLE_LEVELS + 1 : teamCurrentLevel;\n    let maxReachedLevel = teamCurrentLevel > TOTAL_LEVELS ? TOTAL_LEVELS : teamCurrentLevel;\n\n    function formatHintBalance(val) {\n        const num = Number(val);\n        if (Number.isNaN(num)) return val;\n        const truncated = Math.trunc(num * 100) / 100;\n        return truncated.toFixed(2);\n    }\n    \n    // --- API 调用封装 ---\n    async function apiCall(data) {\n        try {\n            const response = await fetch(apiUrl, { \n                method: 'POST', \n                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }, \n                body: JSON.stringify(data) \n            });\n            if (!response.ok) {\n                const errorData = await response.json();\n                return { success: false, error: errorData.message || `HTTP error! status: ${response.status}` };\n            }\n            return response.json();\n        } catch (error) {\n            console.error('API call failed:', error);\n            return { success: false, error: 'Network error' };\n        }\n    }\n\n    // --- UI 更新函数 ---\n    function updateNavButtons() {\n        prevBtn.classList.toggle('disabled', viewingLevel <= 1);\n        // 【关键修复】将 >= 修改为 ===\n        // 只有当正在查看的关卡就是最高可达关卡时，才禁用“下一关”按钮\n        nextBtn.classList.toggle('disabled', viewingLevel === maxReachedLevel);\n    }\n\n    function updateLevelDisplay() {\n        levelDisplay.innerText = viewingLevel;\n        if (viewingLevel === teamCurrentLevel && teamCurrentLevel <= SUBMITTABLE_LEVELS) {\n            levelText.innerHTML = `当前小关: <b id=\"syd-level-display\">${viewingLevel}</b>`;\n        } else {\n            levelText.innerHTML = `查看: 第 <b id=\"syd-level-display\">${viewingLevel}</b> 关`;\n        }\n    }\n    function updateControlsVisibility(levelPassed, correctAnswer) {\n        if (viewingLevel > SUBMITTABLE_LEVELS) {\n            interactionArea.style.display = 'none';\n            attemptsContainer.style.display = 'none';\n            return;\n        }\n        interactionArea.style.display = 'block';\n        if (levelPassed && correctAnswer) {\n            submissionArea.style.display = 'none';\n            answerArea.style.display = 'block';\n            answerDisplay.innerText = correctAnswer;\n            actionsArea.style.display = 'none';\n            attemptsContainer.style.display = 'none';\n        } else {\n            submissionArea.style.display = 'flex';\n            answerArea.style.display = 'none';\n            actionsArea.style.display = 'flex';\n            attemptsContainer.style.display = 'inline';\n        }\n    }\n    async function loadLevelData(level) {\n        feedbackDisplay.innerText = '正在加载关卡...';\n        feedbackDisplay.style.color = 'inherit';\n        const response = await apiCall({ action: 'get_level_data', level: level });\n        \n        if (response.success) {\n            viewingLevel = level;\n            const data = response.level_data;\n            imageEl.src = data.image_url;\n            descriptionEl.innerHTML = data.description || '';\n            attemptsDisplay.innerText = response.team_state.attempts_left;\n            const levelPassed = response.team_state.current_level > level;\n            updateLevelDisplay();\n            updateNavButtons();\n            updateControlsVisibility(levelPassed, data.correct_answer);\n            \n            feedbackDisplay.innerText = '';\n            inputEl.value = '';\n            inputEl.disabled = false;\n            submitBtn.disabled = false;\n        } else {\n            feedbackDisplay.innerText = \"加载关卡失败: \" + response.error;\n            feedbackDisplay.style.color = 'red';\n        }\n    }\n\n    // --- 事件处理 ---\n    async function handleSubmit() {\n        const submission = inputEl.value;\n        if (!submission || submitBtn.disabled) return;\n\n        feedbackDisplay.innerText = \"正在提交...\";\n        feedbackDisplay.style.color = 'inherit';\n        submitBtn.disabled = true;\n\n        const response = await apiCall({ \n            action: 'submit', \n            submission: submission,\n            level: viewingLevel\n        });\n\n        submitBtn.disabled = false;\n        if (!response.success) {\n            feedbackDisplay.innerText = response.message || \"提交失败，请重试\";\n            feedbackDisplay.style.color = 'red';\n            if (response.reason === 'no_attempts') inputEl.disabled = true;\n            return;\n        }\n\n        attemptsDisplay.innerText = response.attempts_left;\n        \n        switch (response.result) {\n            case 'syd_reset_success':\n                feedbackDisplay.innerText = response.message;\n                feedbackDisplay.style.color = 'blue';\n                inputEl.disabled = true;\n                submitBtn.disabled = true;\n                exchangeBtn.disabled = true;\n                setTimeout(() => {\n                    window.location.reload();\n                }, 2000);\n                break;\n            case 'correct':\n                feedbackDisplay.innerText = response.correct_answer \n                    ? `正确！答案是「${response.correct_answer}」。正在进入下一关...` \n                    : \"正确！正在进入下一关...\";\n                feedbackDisplay.style.color = 'green';\n                setTimeout(() => {\n                    teamCurrentLevel = response.new_level;\n                    maxReachedLevel = response.new_level;\n                    loadLevelData(response.new_level);\n                }, 1500);\n                break;\n            case 'final_correct':\n                feedbackDisplay.innerText = response.correct_answer \n                    ? `正确！答案是「${response.correct_answer}」。正在进入下一关...` \n                    : \"正确！正在进入下一关...\";\n                feedbackDisplay.style.color = 'green';\n                setTimeout(() => {\n                    teamCurrentLevel = response.new_level;\n                    maxReachedLevel = Math.min(response.new_level, TOTAL_LEVELS);\n                    loadLevelData(response.new_level);\n                }, 1500);\n                break;\n            case 'correct_already_passed':\n                feedbackDisplay.innerText = response.correct_answer \n                    ? `${response.message} 正确答案：「${response.correct_answer}」` \n                    : response.message;\n                feedbackDisplay.style.color = 'green';\n                break;\n            case 'incorrect':\n                feedbackDisplay.innerText = \"答案错误\";\n                feedbackDisplay.style.color = 'red';\n                inputEl.value = '';\n                break;\n        }\n    }\n    \n    async function handleExchange() {\n        const cost = {{ SYD_HINT_COST|default:1 }};\n        if (!confirm(`你确定要消耗 ${cost} 个提示点来换取更多提交机会吗？`)) {\n            return;\n        }\n\n        exchangeBtn.disabled = true;\n        feedbackDisplay.innerText = \"正在兑换...\";\n        feedbackDisplay.style.color = 'inherit';\n\n        const response = await apiCall({\n            action: 'exchange_hint_for_attempts',\n            level: viewingLevel\n        });\n\n        if (response.success) {\n            feedbackDisplay.innerText = response.message;\n            feedbackDisplay.style.color = 'green';\n            attemptsDisplay.innerText = response.new_attempts_left;\n            hintBalanceDisplay.innerText = formatHintBalance(response.new_hints_remaining);\n        } else {\n            feedbackDisplay.innerText = response.message || \"兑换失败！\";\n            feedbackDisplay.style.color = 'red';\n        }\n\n        exchangeBtn.disabled = false;\n    }\n\n    // --- 页面初始化 ---\n    function initializePage() {\n        if (TOTAL_LEVELS === 0) {\n            descriptionEl.innerText = \"错误：未加载到谜题数据。请检查视图配置。\";\n            descriptionEl.style.color = 'red';\n            return;\n        }\n        loadLevelData(viewingLevel);\n\n        prevBtn.addEventListener('click', () => { if (!prevBtn.classList.contains('disabled')) loadLevelData(viewingLevel - 1); });\n        nextBtn.addEventListener('click', () => { if (!nextBtn.classList.contains('disabled')) loadLevelData(viewingLevel + 1); });\n        submitBtn.addEventListener('click', handleSubmit);\n        inputEl.addEventListener('keyup', (e) => { if (e.key === 'Enter') handleSubmit(); });\n        exchangeBtn.addEventListener('click', handleExchange);\n    }\n\n    initializePage();\n});\n</script>\n<p><a href=\"/DMs\" class=\"btn\">进入站内信</a></p>\n",
  "answer": "SNOW",
  "desc": "<font color=\"#808080\"><i>是向往，还是妄想</i></font>",
  "tips": [
    {
      "title": "我看不懂例题！ (2提示点)",
      "content": "拼音重排。方头括号里的符号提示你哪些前后一样、哪些前后交换、哪些完全相同。"
    },
    {
      "title": "最后一小关是如何得到字母的？ (4提示点)",
      "content": "某处提示了三进制转换方法。"
    },
    {
      "title": "最后一步该怎么做？ (4提示点)",
      "content": "将你得到的两个单词各翻译成一个汉字，然后按要求进行拼音重排，你会得到某一事物的古代雅称。"
    }
  ],
  "additionalAnswers": [
    {
      "answer": "寒酥",
      "message": "这是本题的中间答案！"
    }
  ],
  "links": [
    {
      "title": "索引页",
      "type": "index",
      "path": "seco2/index"
    },
    {
      "title": "庄园",
      "path": "/area/seco2/1",
      "pgid": 1
    },
    {
      "title": "沙海",
      "path": "/area/seco2/2",
      "pgid": 2
    },
    {
      "title": "高塔",
      "path": "/area/seco2/3",
      "pgid": 3
    },
    {
      "title": "花原",
      "path": "/area/seco2/4",
      "pgid": 4
    },
    {
      "title": "暗格",
      "path": "/area/seco2/5",
      "pgid": 5
    },
    {
      "title": "过渡",
      "path": "/area/seco2/6",
      "pgid": 6
    },
    {
      "title": "中心",
      "path": "/area/seco2/7",
      "pgid": 7
    },
    {
      "title": "FM",
      "path": "/area/seco2/8",
      "pgid": 8
    }
  ],
  "arealink": {
    "title": "花原",
    "path": "/area/seco2/4",
    "pgid": 4
  }
}