{
  "type": "problem",
  "title": "像素小游戏",
  "extendData": "",
  "contentType": 1,
  "content": "<style>\n    @font-face {\n        font-family: 'PixelGame';\n        src: url('/static/font/pix.ttf') format('truetype');\n    }\n\n    /* 模拟 800x600 的游戏窗口 */\n    #game-container {\n        width: 800px;\n        height: 600px;\n        background-color: #000; /* 默认黑色背景 */\n        margin: 0 auto;\n        position: relative;\n        font-family: 'PixelGame', 'Courier New', monospace;\n        overflow: hidden;\n        user-select: none;\n        border: 4px solid #444;\n    }\n\n    /* 屏幕层：用于切换菜单、选关、游戏 */\n    .screen-layer {\n        width: 100%;\n        height: 100%;\n        position: absolute;\n        top: 0;\n        left: 0;\n        display: none; /* 默认隐藏 */\n    }\n\n    /* --- 主菜单样式 --- */\n    #screen-menu {\n        background-color: white;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n    }\n    #title-img {\n        image-rendering: pixelated;\n        display: block;\n        margin: 0;\n        width: auto;\n        height: auto;\n        max-width: 100%;\n        max-height: 100%;\n    }\n\n    /* --- 选关界面样式 --- */\n    #screen-select { background-color: #404040; color: white; padding: 20px; box-sizing: border-box; }\n    .select-header { font-size: 36px; text-align: center; margin-bottom: 20px; }\n    /* 选关：固定一行 5 个按钮 */\n    .level-grid {\n        display: grid;\n        grid-template-columns: repeat(5, 100px);\n        gap: 10px;\n        justify-content: center;\n        margin-bottom: 30px;\n    }\n    .level-btn {\n        width: 100px; height: 50px;\n        border: 2px solid black;\n        display: flex; align-items: center; justify-content: center;\n        cursor: pointer; font-size: 24px;\n        background-color: #0064ff; /* Blue */\n    }\n    .level-btn.completed { background-color: #00ff00; /* Green */ color: black; }\n    .level-btn:hover { opacity: 0.8; }\n    .part-title { width: 100%; font-size: 32px; margin-top: 10px; border-bottom: 2px solid #888; }\n    .danger-btn { background-color: #ff3b30; color: white; }\n    /* 选关底部按钮行：宽度与关卡网格一致(5*100 + 4*10 = 540)，保证对齐 3-1/3-5 */\n    .select-footer {\n        width: 540px;\n        margin: 0 auto;\n        display: flex;\n        align-items: center;\n        padding: 10px 0 10px 0;\n    }\n    .select-footer.just-right { justify-content: flex-end; }\n    .select-footer.both-sides { justify-content: space-between; }\n\n    /* --- 游戏界面样式 --- */\n    #screen-game { background-color: white; position: relative; }\n    #game-level-text { font-size: 36px; position: absolute; top: 20px; left: 20px; color: black; }\n    #game-esc-hint { font-size: 24px; position: absolute; bottom: 30px; left: 20px; color: black; }\n    #game-image { \n        position: absolute; \n        left: 50%; top: 50%; \n        transform: translate(-50%, -80%); /* 略微向上 */\n        image-rendering: pixelated; \n    }\n\n    #game-hint-text {\n        position: absolute;\n        left: 50px;\n        bottom: 185px;\n        font-size: 24px;\n        color: black !important;\n    }\n    \n    /* 模拟 Pygame 输入框 */\n    #game-input-box {\n        position: absolute;\n        bottom: 120px; left: 50px;\n        width: 700px; height: 40px;\n        border: 2px solid black;\n        font-size: 36px;\n        line-height: 40px;\n        padding-left: 10px;\n        text-transform: uppercase;\n        background: transparent;\n        outline: none;\n        font-family: 'PixelGame', 'Courier New', monospace;\n        color: black !important;\n        caret-color: black;\n    }\n\n    /* 已完成关卡：关卡内所有文字统一更深的绿色 */\n    #screen-game.level-completed,\n    #screen-game.level-completed #game-level-text,\n    #screen-game.level-completed #game-hint-text,\n    #screen-game.level-completed #game-esc-hint,\n    #screen-game.level-completed #game-input-box {\n        color: #006400 !important;\n    }\n    /* 抖动动画 */\n    @keyframes shake {\n        0% { transform: translate(1px, 1px) rotate(0deg); }\n        10% { transform: translate(-1px, -2px) rotate(-1deg); }\n        20% { transform: translate(-3px, 0px) rotate(1deg); }\n        30% { transform: translate(3px, 2px) rotate(0deg); }\n        40% { transform: translate(1px, -1px) rotate(1deg); }\n        50% { transform: translate(-1px, 2px) rotate(-1deg); }\n        60% { transform: translate(-3px, 1px) rotate(0deg); }\n        70% { transform: translate(3px, 1px) rotate(-1deg); }\n        80% { transform: translate(-1px, -1px) rotate(1deg); }\n        90% { transform: translate(1px, 2px) rotate(0deg); }\n        100% { transform: translate(1px, -2px) rotate(-1deg); }\n    }\n    .shake-effect { animation: shake 0.5s; }\n\n    /* --- 通关界面 --- */\n    #screen-ending { background-color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; width: 100%; }\n    .ending-text { font-size: 36px; color: #00ff00; margin-bottom: 20px; }\n\n</style>\n\n<div id=\"game-container\" tabindex=\"0\">\n    <!-- 1. 主菜单 -->\n    <div id=\"screen-menu\" class=\"screen-layer\">\n        <img id=\"title-img\" src=\"\" alt=\"Title\">\n    </div>\n\n    <!-- 2. 选关界面 -->\n    <div id=\"screen-select\" class=\"screen-layer\">\n        <div class=\"select-header\">Select Level</div>\n        <div style=\"font-size: 16px; margin-bottom: 10px;\">Press ESC to return to Main Menu</div>\n        <div id=\"select-grid-container\" style=\"overflow-y: scroll; height: 500px; padding-bottom: 60px; box-sizing: border-box;\">\n            <!-- 动态生成按钮 -->\n        </div>\n    </div>\n\n    <!-- 3. 游戏界面 -->\n    <div id=\"screen-game\" class=\"screen-layer\">\n        <div id=\"game-level-text\">Level: 1-1</div>\n        <img id=\"game-image\" src=\"\">\n        <input type=\"text\" id=\"game-input-box\" maxlength=\"30\" autocomplete=\"off\">\n        <div id=\"game-hint-text\">Press Enter to submit answer</div>\n        <div id=\"game-esc-hint\">Press ESC to return to level select</div>\n    </div>\n\n    <!-- 4. 结局界面 -->\n    <div id=\"screen-ending\" class=\"screen-layer\">\n        <div class=\"ending-text\">Congratulations! All levels completed!</div>\n        <div style=\"font-size: 24px;\">Press ESC to return to main menu</div>\n    </div>\n</div>\n\n<script>\ndocument.addEventListener('DOMContentLoaded', () => {\n    const container = document.getElementById('game-container');\n    const api = \"{% url 'pixel_api' %}\";\n    const csrf = \"{{ csrf_token }}\";\n\n    // 状态机\n    const gameState = {\n        current: 'MENU', // MENU, SELECT, GAME, ENDING\n        \n        // Main Menu State\n        menuBuffer: \"\",\n        exitSequence: \".2$@-9 #8[>\",\n        \n        // Game State\n        currentLevelKey: null,\n        \n        // Data\n        unlockedLevels: [],\n        completedLevels: [],\n        allCompleted: false,\n\n        change(newState) {\n            document.querySelectorAll('.screen-layer').forEach(el => el.style.display = 'none');\n            \n            if (newState === 'MENU') {\n                // 必须用 flex 才能居中（不能用 block 覆盖 CSS）\n                document.getElementById('screen-menu').style.display = 'flex';\n                this.menuBuffer = \"\";\n                updateTitleImage(\"\");\n            } else if (newState === 'SELECT') {\n                document.getElementById('screen-select').style.display = 'block';\n                loadLevelSelect();\n            } else if (newState === 'GAME') {\n                document.getElementById('screen-game').style.display = 'block';\n                loadGameLevel(this.currentLevelKey);\n            } else if (newState === 'ENDING') {\n                // 结局界面使用 flex 才能上下左右居中（不能用 block 覆盖 CSS）\n                document.getElementById('screen-ending').style.display = 'flex';\n            }\n            this.current = newState;\n            container.focus(); // 保持焦点\n        }\n    };\n\n    // 供行内 onclick 使用（Ending / Clear Save）\n    window.gameState = gameState;\n\n    // --- 逻辑函数 ---\n\n    function updateTitleImage(buf) {\n        // 使用时间戳防止缓存\n        document.getElementById('title-img').src = `{% url 'pixel_title' %}?buf=${encodeURIComponent(buf)}&t=${Date.now()}`;\n    }\n\n    async function loadLevelSelect() {\n        const res = await fetch(api, {\n            method: 'POST',\n            body: JSON.stringify({ action: 'get_state' }),\n            headers: {'X-CSRFToken': csrf}\n        });\n        const data = await res.json();\n        gameState.unlockedLevels = data.unlocked;\n        gameState.completedLevels = data.completed;\n        gameState.allCompleted = data.all_completed;\n        \n        renderLevelGrid();\n    }\n\n    async function resetSave() {\n        const ok = confirm(\"确定要清除存档吗？这会重置已解锁/已完成关卡进度。\");\n        if (!ok) return;\n\n        try {\n            const res = await fetch(api, {\n                method: 'POST',\n                body: JSON.stringify({ action: 'reset_save' }),\n                headers: {'X-CSRFToken': csrf, 'Content-Type': 'application/json'}\n            });\n            if (!res.ok) {\n                alert(\"清除存档失败（请求未成功）\");\n            }\n        } catch (e) {\n            alert(\"清除存档失败（网络或服务器错误）\");\n        }\n\n        // 重新拉取状态刷新 UI\n        await loadLevelSelect();\n    }\n    window.resetSave = resetSave;\n\n    function renderLevelGrid() {\n        const container = document.getElementById('select-grid-container');\n        container.innerHTML = \"\";\n        \n        // 渲染 Part 1, 2, 3\n        for (let part = 1; part <= 3; part++) {\n            const max = (part < 3) ? 15 : 5;\n            const partDiv = document.createElement('div');\n            partDiv.className = 'part-title';\n            partDiv.innerText = `Part ${part}`;\n            container.appendChild(partDiv);\n            \n            const gridDiv = document.createElement('div');\n            gridDiv.className = 'level-grid';\n            \n            for (let i = 1; i <= max; i++) {\n                const key = `${part}-${i}`;\n                if (gameState.unlockedLevels.includes(key)) {\n                    const btn = document.createElement('div');\n                    btn.className = 'level-btn';\n                    if (gameState.completedLevels.includes(key)) btn.classList.add('completed');\n                    btn.innerText = key;\n                    btn.onclick = () => {\n                        gameState.currentLevelKey = key;\n                        gameState.change('GAME');\n                    };\n                    gridDiv.appendChild(btn);\n                }\n            }\n            container.appendChild(gridDiv);\n\n            // Clear Save 固定放在 Part 3 下方（与 Part 3 区域隔一行），不放到最底部\n            if (part === 3) {\n                const gap = document.createElement('div');\n                gap.style.height = '35px';\n                container.appendChild(gap);\n\n                const footer = document.createElement('div');\n                footer.className = 'select-footer ' + (gameState.allCompleted ? 'both-sides' : 'just-right');\n                if (gameState.allCompleted) {\n                    footer.innerHTML = `\n                        <div class=\"level-btn completed\" style=\"width:200px;\" onclick=\"gameState.change('ENDING')\">Ending</div>\n                        <div class=\"level-btn danger-btn\" style=\"width:220px;\" onclick=\"resetSave()\">Clear Save</div>\n                    `;\n                } else {\n                    footer.innerHTML = `<div class=\"level-btn danger-btn\" style=\"width:220px;\" onclick=\"resetSave()\">Clear Save</div>`;\n                }\n                container.appendChild(footer);\n\n                const bottomGap = document.createElement('div');\n                bottomGap.style.height = '30px';\n                container.appendChild(bottomGap);\n            }\n        }\n    }\n\n    function loadGameLevel(key) {\n        // 进入关卡时确保不会残留上一次的抖动效果\n        const gameScreen = document.getElementById('screen-game');\n        gameScreen.classList.remove('shake-effect');\n        gameScreen.classList.remove('level-completed');\n\n        document.getElementById('game-level-text').innerText = `Level: ${key}`;\n        // 切关时先隐藏图片，避免短暂显示上一关内容\n        const img = document.getElementById('game-image');\n        img.style.visibility = 'hidden';\n        img.onload = () => { img.style.visibility = 'visible'; };\n        img.src = `/puzzles/pixel/image/${key}/?t=${Date.now()}`;\n        \n        const inputBox = document.getElementById('game-input-box');\n        inputBox.value = \"\";\n        inputBox.disabled = false;\n        inputBox.style.background = \"transparent\";\n        inputBox.style.color = \"black\";\n        document.getElementById('game-hint-text').innerText = \"Press Enter to submit answer\";\n        inputBox.focus();\n        \n        // 如果已完成：显示正确答案（大写）并禁用输入（与 Python 版一致）\n        if (gameState.completedLevels.includes(key)) {\n            gameScreen.classList.add('level-completed');\n            showCompletedLevelAnswer(key);\n        }\n    }\n\n    async function showCompletedLevelAnswer(levelKey) {\n        const gameScreen = document.getElementById('screen-game');\n        gameScreen.classList.add('level-completed');\n        const inputBox = document.getElementById('game-input-box');\n        inputBox.value = \"\";\n        inputBox.disabled = true;\n        inputBox.style.background = \"#ddd\";\n        inputBox.style.color = \"#006400\";\n        document.getElementById('game-hint-text').innerText = \"Level completed - Press ESC to return\";\n\n        // 不在前端计算答案：交给后端（且应只对已完成关卡返回）\n        try {\n            const res = await fetch(api, {\n                method: 'POST',\n                body: JSON.stringify({ action: 'get_answer', level: levelKey }),\n                headers: {'X-CSRFToken': csrf}\n            });\n            const data = await res.json();\n            if (data && data.answer) {\n                inputBox.value = String(data.answer).toUpperCase();\n            }\n        } catch (e) {\n            // ignore\n        }\n    }\n\n    async function submitAnswer() {\n        const val = document.getElementById('game-input-box').value;\n        const res = await fetch(api, {\n            method: 'POST',\n            body: JSON.stringify({ action: 'submit', level: gameState.currentLevelKey, submission: val }),\n            headers: {'X-CSRFToken': csrf}\n        });\n        const data = await res.json();\n        \n        if (data.result === 'correct') {\n            // 答对后返回选关界面\n            gameState.change('SELECT');\n        } else {\n            // 错误，触发抖动\n            const gameScreen = document.getElementById('screen-game');\n            gameScreen.classList.remove('shake-effect');\n            void gameScreen.offsetWidth; // 触发重绘\n            gameScreen.classList.add('shake-effect');\n            document.getElementById('game-input-box').value = \"\";\n            // 防止下次进入关卡时立刻抖动\n            setTimeout(() => gameScreen.classList.remove('shake-effect'), 600);\n        }\n    }\n\n    // --- 输入监听 (模拟 Pygame 事件循环) ---\n\n    // 1. 全局按键监听\n    document.addEventListener('keydown', (e) => {\n        if (gameState.current === 'MENU') {\n            if (e.key === 'Enter') {\n                gameState.change('SELECT');\n            } else if (e.key.length === 1) { // 可打印字符（包含空格）\n                function easterEggPrompt() {\n                    alert(\"快做题！不准把我关掉！\");\n                }\n\n                // 复刻 Python 版：必须从头按前缀逐字匹配，输错就清空重新开始\n                const maxLen = gameState.exitSequence.length;\n                let newBuf = (gameState.menuBuffer + e.key);\n                if (newBuf.length > maxLen) newBuf = newBuf.slice(-maxLen);\n\n                let matched = true;\n                for (let i = 0; i < Math.min(newBuf.length, gameState.exitSequence.length); i++) {\n                    if (newBuf[i] !== gameState.exitSequence[i]) {\n                        matched = false;\n                        break;\n                    }\n                }\n\n                gameState.menuBuffer = matched ? newBuf : \"\";\n\n                if (gameState.menuBuffer === gameState.exitSequence) {\n                    gameState.menuBuffer = \"\";\n                    updateTitleImage(\"\");\n                    easterEggPrompt();\n                    return;\n                }\n                \n                updateTitleImage(gameState.menuBuffer);\n            }\n        } else if (gameState.current === 'SELECT') {\n            if (e.key === 'Escape') gameState.change('MENU');\n        } else if (gameState.current === 'GAME') {\n            if (e.key === 'Escape') gameState.change('SELECT');\n            if (e.key === 'Enter') submitAnswer();\n        } else if (gameState.current === 'ENDING') {\n            if (e.key === 'Escape') gameState.change('MENU');\n        }\n    });\n    \n    // 初始化\n    gameState.change('MENU');\n    container.focus();\n});\n</script>\n",
  "answer": "PUFF",
  "desc": "<p><font color=\"#808080\"><i>看起来是个复古的电子游戏</i></font></p>",
  "tips": [
    {
      "title": "我有小题需要提示！（该提示不包含3-5答案回复） (4提示点)",
      "content": "请在站内信回复【Pixel Game】并给出需要提示的小题题号，我们会尽快反馈。"
    },
    {
      "title": "3-5的答案是什么？ (6提示点)",
      "content": "Counting Pixels。"
    },
    {
      "title": "我做完了所有题目，该怎么得到答案？ (4提示点)",
      "content": "仔细观察标题界面，你会找到得到答案需要什么；你或许也需要仔细观察和理解第三部分的题目和题目答案。"
    }
  ],
  "additionalAnswers": [],
  "links": [
    {
      "title": "索引页",
      "type": "index",
      "path": "seco2/index"
    },
    {
      "title": "庄园",
      "path": "/area/seco2/1",
      "pgid": 1
    },
    {
      "title": "沙海",
      "path": "/area/seco2/2",
      "pgid": 2
    },
    {
      "title": "高塔",
      "path": "/area/seco2/3",
      "pgid": 3
    },
    {
      "title": "花原",
      "path": "/area/seco2/4",
      "pgid": 4
    },
    {
      "title": "暗格",
      "path": "/area/seco2/5",
      "pgid": 5
    },
    {
      "title": "过渡",
      "path": "/area/seco2/6",
      "pgid": 6
    },
    {
      "title": "中心",
      "path": "/area/seco2/7",
      "pgid": 7
    },
    {
      "title": "FM",
      "path": "/area/seco2/8",
      "pgid": 8
    }
  ],
  "arealink": {
    "title": "花原",
    "path": "/area/seco2/4",
    "pgid": 4
  }
}